{% extends "base.html" %}
{% block title %}Register User{% endblock %}
{% block content %}
    <h1>Register User</h1>
    <form method="post" class="registration-form" novalidate>
        {{ csrf_token }}
        <div class="form-group">
            <label for="code">Registration Code:</label>
            <input type="text" id="code" name="code" value="{{ code }}" pattern="^[A-Za-z0-9-]+$" 
                   title="Registration code can only contain letters, numbers, and hyphens" required>
        </div>
        <div class="form-group">
            <label for="first_name">First Name:</label>
            <input type="text" id="first_name" name="first_name" pattern="^[A-Za-z\s-]+$" 
                   title="First name can only contain letters, spaces, and hyphens" required>
        </div>
        <div class="form-group">
            <label for="last_name">Last Name:</label>
            <input type="text" id="last_name" name="last_name" pattern="^[A-Za-z\s-]+$" 
                   title="Last name can only contain letters, spaces, and hyphens" required>
        </div>
        <div class="form-group">
            <label for="middle_name">Middle Name:</label>
            <input type="text" id="middle_name" name="middle_name" pattern="^[A-Za-z\s-]*$" 
                   title="Middle name can only contain letters, spaces, and hyphens">
        </div>
        <div class="form-group">
            <label for="has_ad">
                <input type="checkbox" id="has_ad" name="has_ad" onchange="toggleAdField()">
                Do you have an Active Directory Account?
            </label>
        </div>
        <div class="form-group" id="ad_account_group" style="display: none;">
            <label for="ad_account_id">Account ID (AD):</label>
            <input type="text" id="ad_account_id" name="ad_account_id" pattern="^[A-Za-z0-9._-]+$"
                   title="AD Account ID can only contain letters, numbers, dots, underscores, and hyphens">
        </div>
        <div class="form-group">
            <label for="rsa_token_id">RSA Token ID:</label>
            <input type="text" id="rsa_token_id" name="rsa_token_id" pattern="^[A-Za-z0-9-]+$"
                   title="RSA Token ID can only contain letters, numbers, and hyphens" required>
        </div>
        <div class="form-group">
            <label for="home_location">Home Location:</label>
            <input type="text" id="home_location" name="home_location" required>
        </div>

        {% for i in range(1, 4) %}
        <div class="form-group security-question">
            <label for="question_{{ i }}">Security Question {{ i }}:</label>
            <select id="question_{{ i }}" name="question_{{ i }}" required onchange="validateQuestions()">
                <option value="">Select a question...</option>
                {% for question in security_questions %}
                <option value="{{ question }}">{{ question }}</option>
                {% endfor %}
            </select><br>
            <label for="answer_{{ i }}">Answer {{ i }}:</label>
            <input type="text" id="answer_{{ i }}" name="answer_{{ i }}" required 
                   minlength="2" maxlength="100">
        </div>
        {% endfor %}

        <div id="error-message" class="error-message" style="display: none;"></div>
        <button type="submit" class="submit-button">Register</button>
    </form>

    {% if msg %}
    <div class="message {% if 'error' in msg|lower %}error{% else %}success{% endif %}">
        {{ msg }}
    </div>
    {% endif %}

    <div class="back-link">
        <a href="/" class="button">Back to Home</a>
    </div>

    <script>
        function toggleAdField() {
            const hasAd = document.getElementById('has_ad').checked;
            const adGroup = document.getElementById('ad_account_group');
            const adInput = document.getElementById('ad_account_id');
            
            adGroup.style.display = hasAd ? 'block' : 'none';
            adInput.required = hasAd;
            if (!hasAd) adInput.value = '';
        }

        function validateQuestions() {
            const selects = document.querySelectorAll('.security-question select');
            const errorDiv = document.getElementById('error-message');
            const submitBtn = document.querySelector('button[type="submit"]');
            const selected = new Set();
            let hasError = false;

            selects.forEach(select => {
                if (select.value) {
                    if (selected.has(select.value)) {
                        hasError = true;
                    }
                    selected.add(select.value);
                }
            });

            if (hasError) {
                errorDiv.textContent = 'Please select different security questions';
                errorDiv.style.display = 'block';
                submitBtn.disabled = true;
            } else {
                errorDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Initialize form state
        document.addEventListener('DOMContentLoaded', function() {
            toggleAdField();
            validateQuestions();
        });
    </script>

    <style>
        .registration-form {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .error-message {
            color: #dc3545;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #dc3545;
            border-radius: 4px;
            background-color: #f8d7da;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .message.error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #dc3545;
        }

        .message.success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #28a745;
        }

        .submit-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .submit-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .back-link {
            margin-top: 20px;
            text-align: center;
        }

        .button {
            display: inline-block;
            padding: 8px 16px;
            text-decoration: none;
            background-color: #6c757d;
            color: white;
            border-radius: 4px;
        }
    </style>
{% endblock %}
